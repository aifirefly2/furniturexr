import{r as c,_ as ie,G as j,d as U,e as F,f as O,g as J,h as Q,i as q,k as ae,M as le,B as ce,V as z,l as K,m as H,n as ue,o as de,p as he}from"./index-cZ1KXA3i.js";var pe=Object.defineProperty,fe=(n,e,t)=>e in n?pe(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,y=(n,e,t)=>(fe(n,typeof e!="symbol"?e+"":e,t),t);const E={Handedness:{NONE:"none",LEFT:"left",RIGHT:"right"},ComponentState:{DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"},ComponentProperty:{BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"},ComponentType:{TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"},ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:{TRANSFORM:"transform",VISIBILITY:"visibility"}};async function Z(n){const e=await fetch(n);if(e.ok)return e.json();throw new Error(e.statusText)}async function me(n){if(!n)throw new Error("No basePath supplied");return await Z(`${n}/profilesList.json`)}async function ve(n,e,t=null,r=!0){if(!n)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const s=await me(e);let a;if(n.profiles.some(i=>{const h=s[i];return h&&(a={profileId:i,profilePath:`${e}/${h.path}`,deprecated:!!h.deprecated}),!!a}),!a){if(!t)throw new Error("No matching profile name found");const i=s[t];if(!i)throw new Error(`No matching profile name found and default profile "${t}" missing.`);a={profileId:t,profilePath:`${e}/${i.path}`,deprecated:!!i.deprecated}}const o=await Z(a.profilePath);let l;if(r){let i;if(n.handedness==="any"?i=o.layouts[Object.keys(o.layouts)[0]]:i=o.layouts[n.handedness],!i)throw new Error(`No matching handedness, ${n.handedness}, in profile ${a.profileId}`);i.assetPath&&(l=a.profilePath.replace("profile.json",i.assetPath))}return{profile:o,assetPath:l}}const ge={xAxis:0,yAxis:0,button:0,state:E.ComponentState.DEFAULT};function xe(n=0,e=0){let t=n,r=e;if(Math.sqrt(n*n+e*e)>1){const o=Math.atan2(e,n);t=Math.cos(o),r=Math.sin(o)}return{normalizedXAxis:t*.5+.5,normalizedYAxis:r*.5+.5}}class ye{constructor(e){y(this,"value"),y(this,"componentProperty"),y(this,"states"),y(this,"valueNodeName"),y(this,"valueNodeProperty"),y(this,"minNodeName"),y(this,"maxNodeName"),y(this,"valueNode"),y(this,"minNode"),y(this,"maxNode"),this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===E.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(ge)}updateFromComponent({xAxis:e,yAxis:t,button:r,state:s}){const{normalizedXAxis:a,normalizedYAxis:o}=xe(e,t);switch(this.componentProperty){case E.ComponentProperty.X_AXIS:this.value=this.states.includes(s)?a:.5;break;case E.ComponentProperty.Y_AXIS:this.value=this.states.includes(s)?o:.5;break;case E.ComponentProperty.BUTTON:this.value=this.states.includes(s)&&r?r:0;break;case E.ComponentProperty.STATE:this.valueNodeProperty===E.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(s):this.value=this.states.includes(s)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class Ee{constructor(e,t){if(y(this,"id"),y(this,"values"),y(this,"type"),y(this,"gamepadIndices"),y(this,"rootNodeName"),y(this,"visualResponses"),y(this,"touchPointNodeName"),y(this,"touchPointNode"),!e||!t||!t.visualResponses||!t.gamepadIndices||Object.keys(t.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach(r=>{const s=new ye(t.visualResponses[r]);this.visualResponses[r]=s}),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:E.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=E.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||this.values.button===1?this.values.state=E.ComponentState.PRESSED:(t.touched||this.values.button>E.ButtonTouchThreshold)&&(this.values.state=E.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===E.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>E.AxisTouchThreshold&&(this.values.state=E.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===E.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>E.AxisTouchThreshold&&(this.values.state=E.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(t=>{t.updateFromComponent(this.values)})}}class Se{constructor(e,t,r){if(y(this,"xrInputSource"),y(this,"assetUrl"),y(this,"layoutDescription"),y(this,"id"),y(this,"components"),!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");if(!t.layouts[e.handedness])throw new Error("No layout for "+e.handedness+" handedness");this.xrInputSource=e,this.assetUrl=r,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(s=>{const a=this.layoutDescription.components[s];this.components[s]=new Ee(s,a)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach(t=>{e.push(t.data)}),e}updateFromGamepad(){Object.values(this.components).forEach(e=>{e.updateFromGamepad(this.xrInputSource.gamepad)})}}function ee(n,e){const t=n+"Geometry";return c.forwardRef(({args:r,children:s,...a},o)=>{const l=c.useRef(null);return c.useImperativeHandle(o,()=>l.current),c.useLayoutEffect(()=>void(e==null?void 0:e(l.current))),c.createElement("mesh",ie({ref:l},a),c.createElement(t,{attach:"geometry",args:r}),s)})}const Ve=ee("box"),We=ee("cylinder");class we extends j{constructor(e,t){super(),this.inputSource=null,this.xrControllerModel=null,this.index=e,this.controller=t.xr.getController(e),this.grip=t.xr.getControllerGrip(e),this.hand=t.xr.getHand(e),this.grip.userData.name="grip",this.controller.userData.name="controller",this.hand.userData.name="hand",this.visible=!1,this.add(this.controller,this.grip,this.hand),this._onConnected=this._onConnected.bind(this),this._onDisconnected=this._onDisconnected.bind(this),this.controller.addEventListener("connected",this._onConnected),this.controller.addEventListener("disconnected",this._onDisconnected)}_onConnected(e){e.fake||e.data&&(this.visible=!0,this.inputSource=e.data,this.dispatchEvent(e))}_onDisconnected(e){e.fake||(this.visible=!1,this.inputSource=null,this.dispatchEvent(e))}dispose(){this.controller.removeEventListener("connected",this._onConnected),this.controller.removeEventListener("disconnected",this._onDisconnected)}}var X,$;const be=n=>Array.from(new Set(n)),M=typeof window<"u"&&((X=window.document)!=null&&X.createElement||(($=window.navigator)==null?void 0:$.product)==="ReactNative")?c.useLayoutEffect:c.useEffect;function I(n){const e=c.useRef(n);return M(()=>void(e.current=n),[n]),e}function _(n,e,{handedness:t}={}){const r=I(e),s=b(a=>a.controllers);M(()=>{const a=s.map(o=>{if(t&&o.inputSource&&o.inputSource.handedness!==t)return;const l=i=>r.current({nativeEvent:i,target:o});return o.controller.addEventListener(n,l),()=>o.controller.removeEventListener(n,l)});return()=>a.forEach(o=>o==null?void 0:o())},[s,t,n])}const D=new U;function Ce({children:n}){const e=O(u=>u.events),t=O(u=>u.get),r=O(u=>u.raycaster),s=b(u=>u.controllers),a=b(u=>u.interactions),o=b(u=>u.hoverState),l=b(u=>u.hasInteraction),i=b(u=>u.getInteraction),h=c.useCallback(u=>{const p=Array.from(a.keys());return D.identity().extractRotation(u.matrixWorld),r.ray.origin.setFromMatrixPosition(u.matrixWorld),r.ray.direction.set(0,0,-1).applyMatrix4(D),r.intersectObjects(p,!0)},[a,r]);F(()=>{var u;if(a.size!==0)for(const p of s){if(!((u=p.inputSource)!=null&&u.handedness))return;const f=o[p.inputSource.handedness],m=new Set;let C=h(p.controller);if(e.filter)C=e.filter(C,t());else{const v=C.find(x=>x==null?void 0:x.object);v&&(C=[v])}for(const v of C){let x=v.object;for(;x;){if(l(x,"onHover")&&!f.has(x)){const d=i(x,"onHover");for(const w of d)w({target:p,intersection:v,intersections:C})}const A=i(x,"onMove");A==null||A.forEach(d=>d({target:p,intersection:v,intersections:C})),f.set(x,v),m.add(x.id),x=x.parent}}for(const v of f.keys())if(!m.has(v.id)){f.delete(v);const x=i(v,"onBlur");if(!x)continue;for(const A of x)A({target:p,intersections:C})}}});const g=c.useCallback(u=>p=>{var f;if(!((f=p.target.inputSource)!=null&&f.handedness))return;const m=o[p.target.inputSource.handedness],C=Array.from(new Set(m.values()));a.forEach((v,x)=>{var A,d,w;if(m.has(x)){if(!v[u])return;for(const S of v[u])(A=S.current)==null||A.call(S,{target:p.target,intersection:m.get(x),intersections:C})}else if(u==="onSelect"&&v.onSelectMissed)for(const S of v.onSelectMissed)(d=S.current)==null||d.call(S,{target:p.target,intersections:C});else if(u==="onSqueeze"&&v.onSqueezeMissed)for(const S of v.onSqueezeMissed)(w=S.current)==null||w.call(S,{target:p.target,intersections:C})})},[o,a]);return _("select",g("onSelect")),_("selectstart",g("onSelectStart")),_("selectend",g("onSelectEnd")),_("squeeze",g("onSqueeze")),_("squeezeend",g("onSqueezeEnd")),_("squeezestart",g("onSqueezeStart")),c.createElement(c.Fragment,null,n)}function R(n,e,t){const r=b(o=>o.addInteraction),s=b(o=>o.removeInteraction),a=I(t);M(()=>{const o=n.current;if(!(!o||!a.current))return r(o,e,a),()=>s(o,e,a)},[n,e,r,s])}const Ne=c.forwardRef(function({onHover:e,onBlur:t,onSelectStart:r,onSelectEnd:s,onSelectMissed:a,onSelect:o,onSqueezeStart:l,onSqueezeEnd:i,onSqueezeMissed:h,onSqueeze:g,onMove:u,children:p},f){const m=c.useRef(null);return c.useImperativeHandle(f,()=>m.current),R(m,"onHover",e),R(m,"onBlur",t),R(m,"onSelectStart",r),R(m,"onSelectEnd",s),R(m,"onSelectMissed",a),R(m,"onSelect",o),R(m,"onSqueezeStart",l),R(m,"onSqueezeEnd",i),R(m,"onSqueezeMissed",h),R(m,"onSqueeze",g),R(m,"onMove",u),c.createElement("group",{ref:m},p)});c.forwardRef(function({onSelectStart:e,onSelectEnd:t,children:r,...s},a){const o=c.useRef(),l=c.useRef(null),i=c.useMemo(()=>new U,[]);return c.useImperativeHandle(a,()=>l.current),F(()=>{const h=o.current,g=l.current;h&&(g.applyMatrix4(i),g.applyMatrix4(h.matrixWorld),g.updateMatrixWorld(),i.copy(h.matrixWorld).invert())}),c.createElement(Ne,{ref:l,onSelectStart:h=>{o.current=h.target.controller,i.copy(h.target.controller.matrixWorld).invert(),e==null||e(h)},onSelectEnd:h=>{h.target.controller===o.current&&(o.current=void 0),t==null||t(h)},...s},r)});function Ye(n){const e=b(s=>s.session),t=c.useRef(),r=c.useMemo(()=>new U,[]);M(()=>{if(!e)return void(t.current=void 0);e.requestReferenceSpace("viewer").then(async s=>{var a;t.current=await((a=e==null?void 0:e.requestHitTestSource)==null?void 0:a.call(e,{space:s}))})},[e]),F((s,a,o)=>{if(!o||!t.current)return;const[l]=o.getHitTestResults(t.current);if(l){const i=s.gl.xr.getReferenceSpace(),h=l.getPose(i);h&&(r.fromArray(h.transform.matrix),n(r,l))}})}const te=c.createContext(null),T=J((n,e)=>({set:n,get:e,session:null,referenceSpaceType:null}));function Me({foveation:n=0,frameRate:e=void 0,referenceSpace:t="local-floor",onSessionStart:r,onSessionEnd:s,onVisibilityChange:a,onInputSourcesChange:o,children:l}){const i=O(d=>d.gl),h=O(d=>d.camera),g=b(d=>d.player),u=b(d=>d.get),p=b(d=>d.set),f=b(d=>d.session),m=b(d=>d.controllers),C=I(r),v=I(s),x=I(a),A=I(o);return M(()=>{const d=[0,1].map(w=>{const S=new we(w,i),L=()=>p(N=>({controllers:[...N.controllers,S]})),P=()=>p(N=>({controllers:N.controllers.filter(k=>k!==S)}));return S.addEventListener("connected",L),S.addEventListener("disconnected",P),()=>{S.removeEventListener("connected",L),S.removeEventListener("disconnected",P)}});return()=>d.forEach(w=>w())},[i,p]),M(()=>T.subscribe(({session:d})=>p(()=>({session:d}))),[i.xr,p]),M(()=>{i.xr.setFoveation(n),p(()=>({foveation:n}))},[i.xr,n,p]),M(()=>{var d;try{e&&((d=f==null?void 0:f.updateTargetFrameRate)==null||d.call(f,e))}catch{}p(()=>({frameRate:e}))},[f,e,p]),M(()=>{const d=T.getState();i.xr.setReferenceSpaceType(t),p(()=>({referenceSpace:t})),d.set({referenceSpaceType:t})},[i.xr,t,p]),M(()=>{if(!f)return void i.xr.setSession(null);const d=P=>{var N;p(()=>({isPresenting:!0})),(N=C.current)==null||N.call(C,{nativeEvent:{...P,target:f},target:f})},w=P=>{var N;p(()=>({isPresenting:!1,session:null})),T.setState(()=>({session:null})),(N=v.current)==null||N.call(v,{nativeEvent:{...P,target:f},target:f})},S=P=>{var N;(N=x.current)==null||N.call(x,{nativeEvent:P,target:f})},L=P=>{var N;const k=Object.values(f.inputSources).some(re=>re.hand);p(()=>({isHandTracking:k})),(N=A.current)==null||N.call(A,{nativeEvent:P,target:f})};return i.xr.addEventListener("sessionstart",d),i.xr.addEventListener("sessionend",w),f.addEventListener("visibilitychange",S),f.addEventListener("inputsourceschange",L),i.xr.setSession(f).then(()=>{i.xr.setFoveation(u().foveation)}),()=>{i.xr.removeEventListener("sessionstart",d),i.xr.removeEventListener("sessionend",w),f.removeEventListener("visibilitychange",S),f.removeEventListener("inputsourceschange",L)}},[f,i.xr,p,u]),c.createElement(Ce,null,c.createElement("primitive",{object:g},c.createElement("primitive",{object:h}),m.map(d=>c.createElement("primitive",{key:d.index,object:d}))),l)}function Je(n){const e=c.useMemo(()=>J((t,r)=>({set:t,get:r,controllers:[],isPresenting:!1,isHandTracking:!1,player:new j,session:null,foveation:0,referenceSpace:"local-floor",hoverState:{left:new Map,right:new Map,none:new Map},interactions:new Map,hasInteraction(s,a){var o;return!!((o=r().interactions.get(s))!=null&&o[a].some(l=>l.current))},getInteraction(s,a){var o;return(o=r().interactions.get(s))==null?void 0:o[a].reduce((l,i)=>(i.current&&l.push(i.current),l),[])},addInteraction(s,a,o){const l=r().interactions;l.has(s)||l.set(s,{onHover:[],onBlur:[],onSelect:[],onSelectEnd:[],onSelectStart:[],onSelectMissed:[],onSqueeze:[],onSqueezeEnd:[],onSqueezeStart:[],onSqueezeMissed:[],onMove:[]}),l.get(s)[a].push(o)},removeInteraction(s,a,o){const l=r().interactions.get(s);if(l){const i=l[a].indexOf(o);i!==-1&&l[a].splice(i,1)}}})),[]);return c.createElement(te.Provider,{value:e},c.createElement(Me,{...n}))}const Ae=(n,e)=>{var t;if(!(!n&&!e))return n&&!e?{optionalFeatures:[n]}:n&&e?{...e,optionalFeatures:be([...(t=e.optionalFeatures)!=null?t:[],n])}:e},Re=async(n,e)=>{const t=T.getState();if(t.session){console.warn("@react-three/xr: session already started, please stop it first");return}const r=Ae(t.referenceSpaceType,e),s=await navigator.xr.requestSession(n,r);return t.set(()=>({session:s})),s},Pe=async()=>{const n=T.getState();if(!n.session){console.warn("@react-three/xr: no session to stop, please start it first");return}await n.session.end(),n.set({session:null})},Ie=async(n,{sessionInit:e,enterOnly:t,exitOnly:r}={})=>{const s=T.getState();if(!(s.session&&t)&&!(!s.session&&r))return s.session?await Pe():await Re(n,e)},Te=(n,e,t)=>{switch(n){case"entered":return`Exit ${e}`;case"exited":return`Enter ${e}`;case"unsupported":default:switch(t){case"https":return"HTTPS needed";case"security":return`${e} blocked`;case"unknown":default:return`${e} unsupported`}}},ne=c.forwardRef(function({mode:e,sessionInit:t,enterOnly:r=!1,exitOnly:s=!1,onClick:a,onError:o,children:l,...i},h){var g;const[u,p]=c.useState("exited"),[f,m]=c.useState("unknown"),C=Te(u,e,f),v=e==="inline"?e:`immersive-${e.toLowerCase()}`,x=I(o);M(()=>{if(!(navigator!=null&&navigator.xr))return void p("unsupported");navigator.xr.isSessionSupported(v).then(d=>{if(d)p("exited");else{const w=location.protocol==="https:";p("unsupported"),m(w?"unknown":"https")}}).catch(d=>{p("unsupported"),"name"in d&&d.name==="SecurityError"?m("security"):m("unknown")})},[v]),M(()=>T.subscribe(d=>{d.session?p("entered"):u!=="unsupported"&&p("exited")}),[u]);const A=c.useCallback(async d=>{a==null||a(d);try{Ie(v,{sessionInit:t,enterOnly:r,exitOnly:s})}catch(w){const S=x.current;if(S&&w instanceof Error)S(w);else throw w}},[a,v,t,r,s,x]);return c.createElement("button",{...i,ref:h,onClick:u==="unsupported"?a:A},(g=typeof l=="function"?l(u):l)!=null?g:C)}),se={position:"absolute",bottom:"24px",left:"50%",transform:"translateX(-50%)",padding:"12px 24px",border:"1px solid white",borderRadius:"4px",background:"rgba(0, 0, 0, 0.1)",color:"white",font:"normal 0.8125rem sans-serif",outline:"none",zIndex:99999,cursor:"pointer"};c.forwardRef(({style:n=se,sessionInit:e={domOverlay:typeof document<"u"?{root:document.body}:void 0,optionalFeatures:["hit-test","dom-overlay","dom-overlay-for-handheld-ar"]},children:t,...r},s)=>c.createElement(ne,{...r,ref:s,mode:"AR",style:n,sessionInit:e},t));c.forwardRef(({style:n=se,sessionInit:e={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]},children:t,...r},s)=>c.createElement(ne,{...r,ref:s,mode:"VR",style:n,sessionInit:e},t));function b(n=t=>t,e){const t=c.useContext(te);if(!t)throw new Error("useXR must be used within an <XR /> component!");return t(n,e)}const _e="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",Le="generic-trigger";class Oe{constructor(e=null,t=_e){this.gltfLoader=e??new Q,this.path=t,this._assetCache={}}initializeControllerModel(e,t){return t.targetRayMode!=="tracked-pointer"||!t.gamepad?Promise.resolve():ve(t,this.path,Le).then(({profile:r,assetPath:s})=>{if(!s)throw new Error("no asset path");const a=new Se(t,r,s);e.connectMotionController(a);const o=a.assetUrl,l=this._assetCache[o];if(l){const i=l.scene.clone();e.connectModel(i)}else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(o,i=>{if(!e.motionController){console.warn("motionController gone while gltf load, bailing...");return}this._assetCache[o]=i;const h=i.scene.clone();e.connectModel(h)},void 0,()=>{throw new Error(`Asset ${o} missing or malformed.`)})}}).catch(r=>{console.warn(r)})}}const G=n=>"envMap"in n,V=(n,e)=>{n.envMap=e,n.needsUpdate=!0},oe=(n,e)=>{e instanceof q&&(Array.isArray(e.material)?e.material.forEach(t=>G(t)?V(t,n):void 0):G(e.material)&&V(e.material,n))},W=n=>"envMapIntensity"in n,Y=(n,e)=>{n.envMapIntensity=e,n.needsUpdate=!0},B=(n,e)=>{e instanceof q&&(Array.isArray(e.material)?e.material.forEach(t=>W(t)?Y(t,n):void 0):W(e.material)&&Y(e.material,n))};function Fe(n,e){Object.values(n.components).forEach(t=>{const{type:r,touchPointNodeName:s,visualResponses:a}=t;if(r===E.ComponentType.TOUCHPAD&&s)if(t.touchPointNode=e.getObjectByName(s),t.touchPointNode){const o=new ae(.001),l=new le({color:255}),i=new q(o,l);t.touchPointNode.add(i)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(a).forEach(o=>{const{valueNodeName:l,minNodeName:i,maxNodeName:h,valueNodeProperty:g}=o;if(g===E.VisualResponseProperty.TRANSFORM&&i&&h){if(o.minNode=e.getObjectByName(i),o.maxNode=e.getObjectByName(h),!o.minNode){console.warn(`Could not find ${i} in the model`);return}if(!o.maxNode){console.warn(`Could not find ${h} in the model`);return}}o.valueNode=e.getObjectByName(l),o.valueNode||console.warn(`Could not find ${l} in the model`)})})}function ke(n,e){Fe(n.motionController,e),(n.envMap||n.envMapIntensity!=null)&&e.traverse(t=>{n.envMap&&oe(n.envMap,t),n.envMapIntensity!=null&&B(n.envMapIntensity,t)}),n.add(e)}class He extends j{constructor(){super(),this.motionController=null,this.envMap=null,this.envMapIntensity=1,this.scene=null}setEnvironmentMap(e,t=1){var r;return this.envMap===e&&this.envMapIntensity===t?this:(this.envMap=e,this.envMapIntensity=t,(r=this.scene)==null||r.traverse(s=>{oe(e,s),B(t,s)}),this)}setEnvironmentMapIntensity(e){var t;return this.envMapIntensity===e?this:(this.envMapIntensity=e,(t=this.scene)==null||t.traverse(r=>B(e,r)),this)}connectModel(e){if(!this.motionController){console.warn("scene tried to add, but no motion controller");return}this.scene=e,ke(this,e),this.dispatchEvent({type:"modelconnected",data:e})}connectMotionController(e){this.motionController=e,this.dispatchEvent({type:"motionconnected",data:e})}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(t=>{Object.values(t.visualResponses).forEach(r=>{const{valueNode:s,minNode:a,maxNode:o,value:l,valueNodeProperty:i}=r;s&&(i===E.VisualResponseProperty.VISIBILITY&&typeof l=="boolean"?s.visible=l:i===E.VisualResponseProperty.TRANSFORM&&a&&o&&typeof l=="number"&&(s.quaternion.slerpQuaternions(a.quaternion,o.quaternion,l),s.position.lerpVectors(a.position,o.position,l)))})}))}disconnect(){this.dispatchEvent({type:"motiondisconnected",data:this.motionController}),this.dispatchEvent({type:"modeldisconnected",data:this.scene}),this.motionController=null,this.scene&&this.remove(this.scene),this.scene=null}dispose(){this.disconnect()}}const Be=c.forwardRef(function({target:e,hideOnBlur:t=!1,...r},s){const a=b(i=>i.hoverState),o=c.useRef(null),l=c.useMemo(()=>new ce().setFromPoints([new z(0,0,0),new z(0,0,-1)]),[]);return c.useImperativeHandle(s,()=>o.current),F(()=>{if(!e.inputSource)return;let i=1;const h=a[e.inputSource.handedness].values().next().value;h&&e.inputSource.handedness!=="none"?(i=h.distance,t&&(o.current.visible=!1)):t&&(o.current.visible=!0);const g=-.01;o.current.scale.z=i+g}),c.createElement("line",{ref:o,geometry:l,"material-opacity":.8,"material-transparent":!0,...r})}),je=new Oe,Ue=({target:n,envMap:e,envMapIntensity:t})=>{const r=c.useRef(null),s=I(i=>{e!=null&&i.setEnvironmentMap(e)}),a=I(i=>i.setEnvironmentMap(null)),o=I(i=>{t!=null&&i.setEnvironmentMapIntensity(t)}),l=c.useCallback(i=>{var h,g,u;if(r.current=i,i){if(n.xrControllerModel=i,(h=n.inputSource)!=null&&h.hand)return;s.current(i),o.current(i),n.inputSource?je.initializeControllerModel(i,n.inputSource):console.warn("no input source on XRController when handleControllerModel")}else{if((g=n.inputSource)!=null&&g.hand)return;(u=n.xrControllerModel)==null||u.disconnect(),n.xrControllerModel=null}},[n,o,s]);return c.useLayoutEffect(()=>{r.current&&(e?s.current(r.current):a.current(r.current))},[e,s,a]),c.useLayoutEffect(()=>{r.current&&o.current(r.current)},[t,o]),c.createElement("xRControllerModel",{ref:l})};function Qe({rayMaterial:n={},hideRaysOnBlur:e=!1,envMap:t,envMapIntensity:r}){const s=b(l=>l.controllers),a=b(l=>l.isHandTracking),o=c.useMemo(()=>Object.entries(n).reduce((l,[i,h])=>({...l,[`material-${i}`]:h}),{}),[JSON.stringify(n)]);return c.useMemo(()=>K({XRControllerModel:He}),[]),c.createElement(c.Fragment,null,s.map((l,i)=>c.createElement(c.Fragment,{key:i},H(c.createElement(Ue,{target:l,envMap:t,envMapIntensity:r}),l.grip),H(c.createElement(Be,{visible:!a,hideOnBlur:e,target:l,...o}),l.controller))))}const qe="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/";class ze{constructor(e,t,r=qe,s,a){this.controller=t,this.handModel=e,this.bones=[];const o=new Q;a||o.setPath(r),o.load(a??`${s}.glb`,l=>{const i=l.scene.children[0];this.handModel.add(i),this.scene=i;const h=i.getObjectByProperty("type","SkinnedMesh");h.frustumCulled=!1,h.castShadow=!0,h.receiveShadow=!0,["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"].forEach(u=>{const p=i.getObjectByName(u);p!==void 0?p.jointName=u:console.warn(`Couldn't find ${u} in ${s} hand mesh`),this.bones.push(p)})})}updateMesh(){const e=this.controller.joints;let t=!0;for(let r=0;r<this.bones.length;r++){const s=this.bones[r];if(s){const a=e[s.jointName];if(a.visible){const o=a.position;s.position.copy(o),s.quaternion.copy(a.quaternion),t=!1}}}t&&this.scene?this.scene.visible=!1:this.scene&&(this.scene.visible=!0)}dispose(){this.scene&&this.handModel.remove(this.scene)}}const Xe=.01,$e="index-finger-tip";class De extends ue{constructor(e,t,r){super(),this._onConnected=s=>{const a=s.data;a.hand&&!this.motionController&&(this.xrInputSource=a,this.motionController=new ze(this,this.controller,void 0,a.handedness,a.handedness==="left"?this.leftModelPath:this.rightModelPath))},this._onDisconnected=()=>{var s;(s=this.xrInputSource)!=null&&s.hand&&this.motionControllerCleanup()},this.controller=e,this.motionController=null,this.envMap=null,this.leftModelPath=t,this.rightModelPath=r,this.mesh=null,this.xrInputSource=null,e.addEventListener("connected",this._onConnected),e.addEventListener("disconnected",this._onDisconnected)}motionControllerCleanup(){var e;this.clear(),(e=this.motionController)==null||e.dispose(),this.motionController=null}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&this.motionController.updateMesh()}getPointerPosition(){const e=this.controller.joints[$e];return e?e.position:null}intersectBoxObject(e){const t=this.getPointerPosition();if(t){const r=new de(t,Xe),s=new he().setFromObject(e);return r.intersectsBox(s)}else return!1}checkButton(e){this.intersectBoxObject(e)?e.onPress():e.onClear(),e.isPressed()&&e.whilePressed()}dispose(){this.motionControllerCleanup(),this.controller.removeEventListener("connected",this._onConnected),this.controller.removeEventListener("disconnected",this._onDisconnected)}}function Ke({modelLeft:n,modelRight:e}){const t=b(r=>r.controllers);return c.useMemo(()=>K({OculusHandModel:De}),[]),M(()=>{for(const r of t)r.hand.dispatchEvent({type:"connected",data:r.inputSource,fake:!0})},[t,n,e]),c.createElement(c.Fragment,null,t.map(({hand:r})=>H(c.createElement("oculusHandModel",{args:[r,n,e]}),r)))}export{Ve as B,Qe as C,Ke as H,Ne as I,Je as X,ne as a,_ as b,We as c,Ye as u};
